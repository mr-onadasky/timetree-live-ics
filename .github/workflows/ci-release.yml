name: CI & Publish

on:
    push:
        branches: [main]
        tags: ["v*", "timetree-live-ics-v*"]
    release:
        types: [published]
    pull_request:
        branches: [main]

env:
    NODE_VERSION: 20
    IMAGE_NAME: timetree-live-ics

jobs:
    test:
        name: Test & Build
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - name: Use Node.js ${{ env.NODE_VERSION }}
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: npm
            - name: Install deps
              run: npm ci
            - name: Run tests
              run: npm test
            - name: Build
              run: npm run build

    publish-ghcr:
        name: Publish GHCR Image
        needs: test
        if: (github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/'))) || github.event_name == 'release'
        runs-on: ubuntu-latest
        env:
            APP_VERSION: "0.0.0"   # default; overwritten by metadata step
            BUILD_TIME: "unknown"  # default; overwritten by metadata step
        permissions:
            contents: read
            packages: write
        steps:
            - uses: actions/checkout@v4
            - name: Docker meta
              id: meta
              uses: docker/metadata-action@v5
              with:
                  images: ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}
                  tags: |
                      type=ref,event=branch,branch=main
                      type=ref,event=tag
                      type=match,pattern=^timetree-live-ics-v(?<version>.*)$
                      type=semver,pattern={{version}}
                      type=semver,pattern=v{{version}}
                      type=sha
                      type=raw,value=latest,enable={{is_default_branch}}
            - name: Set build metadata
              run: |
                  echo "BUILD_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_ENV
                  APP_VERSION="${{ steps.meta.outputs.version }}"
                  # Fallbacks: tag name, then package.json
                  if [ -z "$APP_VERSION" ] && [ "${GITHUB_REF_TYPE}" = "tag" ]; then
                    case "${GITHUB_REF_NAME}" in
                      timetree-live-ics-v*) APP_VERSION="${GITHUB_REF_NAME#timetree-live-ics-v}" ;;
                      v*) APP_VERSION="${GITHUB_REF_NAME#v}" ;;
                    esac
                  fi
                  # If still empty or not semver-ish, read package.json
                  if ! echo "$APP_VERSION" | grep -Eq '^[0-9]+\.[0-9]+\.[0-9]+$'; then
                    APP_VERSION=$(node -p "require('./package.json').version")
                  fi
                  echo "APP_VERSION=$APP_VERSION" >> $GITHUB_ENV
            - name: Compose extra tags (GHCR)
              id: taglist-ghcr
              run: |
                  echo "EXTRA_TAGS<<'EOF'" >> "$GITHUB_OUTPUT"
                  if [ "${GITHUB_REF_TYPE}" = "tag" ]; then
                    echo "ghcr.io/${GITHUB_REPOSITORY_OWNER}/${{ env.IMAGE_NAME }}:${APP_VERSION}" >> "$GITHUB_OUTPUT"
                    echo "ghcr.io/${GITHUB_REPOSITORY_OWNER}/${{ env.IMAGE_NAME }}:v${APP_VERSION}" >> "$GITHUB_OUTPUT"
                  fi
                  echo "EOF" >> "$GITHUB_OUTPUT"

            - name: Set up Buildx
              uses: docker/setup-buildx-action@v3

            - name: Login to GHCR
              uses: docker/login-action@v3
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Build & Push (GHCR)
              uses: docker/build-push-action@v6
              with:
                  context: .
                  file: ./Dockerfile
                  push: true
                  tags: |
                      ${{ steps.taglist-ghcr.outputs.EXTRA_TAGS }}
                      ${{ steps.meta.outputs.tags }}
                  labels: ${{ steps.meta.outputs.labels }}
                  build-args: |
                      APP_VERSION=${{ env.APP_VERSION }}
                      GIT_SHA=${{ github.sha }}
                      BUILD_TIME=${{ env.BUILD_TIME }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

    publish-dockerhub:
        name: Publish Docker Hub Image
        needs: test
        if: (github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/'))) || github.event_name == 'release'
        runs-on: ubuntu-latest
        env:
            APP_VERSION: "0.0.0"   # default; overwritten by metadata step
            BUILD_TIME: "unknown"  # default; overwritten by metadata step
        permissions:
            contents: read
        steps:
            - uses: actions/checkout@v4
            - name: Docker meta
              id: meta
              uses: docker/metadata-action@v5
              with:
                  images: docker.io/${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}
                  tags: |
                      type=ref,event=branch,branch=main
                      type=ref,event=tag
                      type=match,pattern=^timetree-live-ics-v(?<version>.*)$
                      type=semver,pattern={{version}}
                      type=semver,pattern=v{{version}}
                      type=sha
                      type=raw,value=latest,enable={{is_default_branch}}
            - name: Set build metadata
              run: |
                  echo "BUILD_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_ENV
                  APP_VERSION="${{ steps.meta.outputs.version }}"
                  if [ -z "$APP_VERSION" ] && [ "${GITHUB_REF_TYPE}" = "tag" ]; then
                    case "${GITHUB_REF_NAME}" in
                      timetree-live-ics-v*) APP_VERSION="${GITHUB_REF_NAME#timetree-live-ics-v}" ;;
                      v*) APP_VERSION="${GITHUB_REF_NAME#v}" ;;
                    esac
                  fi
                  if ! echo "$APP_VERSION" | grep -Eq '^[0-9]+\.[0-9]+\.[0-9]+$'; then
                    APP_VERSION=$(node -p "require('./package.json').version")
                  fi
                  echo "APP_VERSION=$APP_VERSION" >> $GITHUB_ENV
            - name: Compose extra tags (Docker Hub)
              id: taglist-dh
              run: |
                  echo "EXTRA_TAGS<<'EOF'" >> "$GITHUB_OUTPUT"
                  if [ "${GITHUB_REF_TYPE}" = "tag" ]; then
                    echo "docker.io/${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${APP_VERSION}" >> "$GITHUB_OUTPUT"
                    echo "docker.io/${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:v${APP_VERSION}" >> "$GITHUB_OUTPUT"
                  fi
                  echo "EOF" >> "$GITHUB_OUTPUT"

            - name: Set up Buildx
              uses: docker/setup-buildx-action@v3

            - name: Login to Docker Hub
              uses: docker/login-action@v3
              with:
                  username: ${{ secrets.DOCKERHUB_USERNAME }}
                  password: ${{ secrets.DOCKERHUB_TOKEN }}

            - name: Build & Push (Docker Hub)
              uses: docker/build-push-action@v6
              with:
                  context: .
                  file: ./Dockerfile
                  push: true
                  tags: |
                      ${{ steps.taglist-dh.outputs.EXTRA_TAGS }}
                      ${{ steps.meta.outputs.tags }}
                  labels: ${{ steps.meta.outputs.labels }}
                  build-args: |
                      APP_VERSION=${{ env.APP_VERSION }}
                      GIT_SHA=${{ github.sha }}
                      BUILD_TIME=${{ env.BUILD_TIME }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max
